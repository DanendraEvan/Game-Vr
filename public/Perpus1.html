<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>VR Dialog System - Dalam Perpustakaan</title>
  <meta name="description" content="VR Dialog System dengan A-Frame" />

  <!-- Core A-Frame -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

  <!-- Library pendukung -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script>
  <script src="/easyrtc/easyrtc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/networked-aframe@0.14.0/dist/networked-aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.5.0/dist/aframe-environment-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fern-solutions/aframe-mirror@1.1.1/dist/mirror.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-cursor-teleport@1.6.0/dist/aframe-cursor-teleport-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AdaRoseCannon/aframe-xr-boilerplate@bca4792/simple-navmesh-constraint.js"></script>
  <script src="/dist/components.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/editvr/aframe-dialog-popup-component/dist/aframe-dialog-popup-component.min.js"></script>
  <script defer src="/dist/ui.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { background: #222; }
    ::-webkit-scrollbar { width: 0 !important }
    #hud {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 8px 12px;
      font-family: monospace;
      font-size: 14px;
      border-radius: 5px;
      z-index: 999;
      white-space: pre-line;
    }
  </style>
</head>
<body>

<div id="hud">Koordinat: X: 0.00 Y: 0.00 Z: 0.00</div>

<a-scene
  networked-scene="connectOnLoad: false; room: perpus; debug: true; adapter: wseasyrtc;"
  shadow="type: pcfsoft"
  gltf-model="meshoptDecoderPath:https://unpkg.com/meshoptimizer@0.19.0/meshopt_decoder.js"
  raycaster="far: 10; objects: .clickable"
  cursor="rayOrigin: mouse"
  vr-detector
  hud-coords
>

  <!-- Assets -->
  <a-assets>
    <template id="avatar-template">
      <a-entity player-info>
        <a-entity class="model">
          <a-text class="nametag" align="center" value="?" position="0 2.1 0" scale=".5 .5 .5"></a-text>
        </a-entity>
        <a-entity class="camera" position="0 1.6 0"></a-entity>
      </a-entity>
    </template>

    <img id="thumbDesa" crossorigin="anonymous" src="https://cdn.aframe.io/link-traversal/thumbs/forest.png" alt="Kembali ke Desa" />

    <!-- Hanya satu asset tempat -->
    <a-asset-item id="perpus-model" src="DalamPerpus.glb"></a-asset-item>
  </a-assets>

  <!-- Scene -->
  <a-entity id="scene">
    <a-sky color="#87CEEB"></a-sky>

    <!-- Lighting -->
    <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="-1 2 1"></a-entity>
    <a-entity light="type: hemisphere; color: #FFF; groundColor: #808080; intensity: 0.5"></a-entity>

    <!-- Model utama: Dalam Perpustakaan -->
    <a-entity gltf-model="#perpus-model" position="0 2 0" scale="0.100 0.01 0.10" shadow="receive: true"></a-entity>

    <!-- Portal kembali ke Desa (opsional) -->
    <a-link
      change-room="on: obbcollisionstarted; room: desa; url: desa.html"
      link="on: ignore"
      href="desa.html"
      position="0 1.6 -5"
      title="Kembali ke Desa Harmoni"
      image="#thumbDesa">
      <a-box position="0 0 0" obb-collider visible="false"></a-box>
    </a-link>

    <!-- Info popup -->
    <a-entity id="info-dialog-onload" position="0 3 -4">
      <a-plane width="7" height="1.2" color="#1e293b" opacity="0.9" material="shader: flat"></a-plane>
      <a-text 
        value="Selamat datang di Dalam Perpustakaan!"
        align="center"
        color="#fff"
        position="0 0 0.05"
        text="width: 12; wrapCount: 60; font: dejavu; weight: bold"></a-text>
    </a-entity>
  </a-entity>

  <!-- Rig (player) -->
  <a-entity
    id="rig"
    position="0 0 0"
    cursor-teleport="cameraRig: #rig; cameraHead: #player; collisionEntities: .environmentGround; ignoreEntities: .clickable,[link]"
    movement-controls="fly:false; controls: gamepad, trackpad, keyboard, nipple;"
    spawn-in-circle="radius:1"
    networked="template:#avatar-template; attachTemplateToLocal:false"
    player-info
  >
    <a-entity id="player" class="camera" camera position="0 1.6 0" look-controls>
      <a-box obb-collider visible="false" height="4" depth="4" width="0.4"></a-box>
      <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable; far: 10"></a-entity>
    </a-entity>
  </a-entity>

</a-scene>

<script>
AFRAME.registerComponent('hud-coords', {
  tick: function () {
    const player = document.querySelector('#player');
    const hud = document.getElementById('hud');
    if (player && hud) {
      const pos = player.object3D.getWorldPosition(new THREE.Vector3());
      hud.innerText = `Koordinat:\nX: ${pos.x.toFixed(2)}\nY: ${pos.y.toFixed(2)}\nZ: ${pos.z.toFixed(2)}`;
    }
  }
});

AFRAME.registerComponent('vr-detector', {
  init: function () {
    this.el.addEventListener('enter-vr', () => gameState.vrMode = true);
    this.el.addEventListener('exit-vr', () => gameState.vrMode = false);
  }
});

let gameState = { currentDialog: null, dialogHistory: [], vrMode: false };
</script>
</body>
</html>
