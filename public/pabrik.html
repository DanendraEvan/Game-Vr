<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <title>VR Dialog System - Pabrik</title>
  <meta name="description" content="VR Dialog System dengan A-Frame" />

  <!-- Pakai hanya satu versi A-Frame -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>

  <!-- Lib pendukung -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script>
  <script src="/easyrtc/easyrtc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/networked-aframe@0.14.0/dist/networked-aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.5.0/dist/aframe-environment-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fern-solutions/aframe-mirror@1.1.1/dist/mirror.umd.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/gh/c-frame/aframe-cursor-teleport@1.6.0/dist/aframe-cursor-teleport-component.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/gh/AdaRoseCannon/aframe-xr-boilerplate@bca4792/simple-navmesh-constraint.js"></script>
  <script src="/dist/components.js"></script>
  <script
    src="https://cdn.jsdelivr.net/gh/editvr/aframe-dialog-popup-component/dist/aframe-dialog-popup-component.min.js"></script>
  <script defer src="/dist/ui.js"></script>

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      background: #222;
    }

    ::-webkit-scrollbar {
      width: 0 !important
    }

    #hud {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 8px 12px;
      font-family: monospace;
      font-size: 14px;
      border-radius: 5px;
      z-index: 999;
      white-space: pre-line;
    }
  </style>
    <!-- Dialog System Scripts -->
<script src="js/dialogs.js"></script>
<script src="js/npc-dialog-system.js"></script>
</head>

<body>

  <div id="hud">Koordinat: X: 0.00 Y: 0.00 Z: 0.00</div>

  <a-scene networked-scene="connectOnLoad: false; room: pabrik; debug: true; adapter: wseasyrtc;" shadow="type: pcfsoft"
    gltf-model="meshoptDecoderPath:https://unpkg.com/meshoptimizer@0.19.0/meshopt_decoder.js"
    raycaster="far: 10; objects: .clickable" cursor="rayOrigin: mouse" vr-detector hud-coords>

    <!-- Musik Latar -->
<a-assets>
  <audio id="bgm" src="Pabrik.mp3" preload="auto"></audio>
</a-assets>

<a-entity sound="src: #bgm; autoplay: true; loop: true; volume: 1"></a-entity>

    <a-assets>
      <template id="avatar-template">
        <a-entity player-info>
          <a-entity class="model">
            <a-text class="nametag" align="center" value="?" position="0 2.1 0" scale=".5 .5 .5"></a-text>
          </a-entity>
          <a-entity class="camera" position="0 1.6 0"></a-entity>
        </a-entity>
      </template>
      <img id="thumbDesa" crossorigin="anonymous" src="https://cdn.aframe.io/link-traversal/thumbs/forest.png"
        alt="Desa" />
      <a-asset-item id="pabrik-model" src="models/pabrik.glb"></a-asset-item>
      <a-asset-item id="signArrow" src="models/signArrow.glb"></a-asset-item>
      <a-asset-item id="village-model" src="models/Untitled.glb"></a-asset-item>
    </a-assets>
    <a-entity gltf-model="models/sky_dome_demo.glb" scale="18 18 18" position="0 0 0" rotation="0 0 0"></a-entity>

    <a-entity id="scene">
      <a-sky color="#87CEEB"></a-sky>

      <!-- Lighting -->
      <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="-1 2 1"></a-entity>
      <a-entity light="type: hemisphere; color: #FFF; groundColor: #808080; intensity: 0.5"></a-entity>

      <!-- Pabrik -->
      <a-entity gltf-model="#pabrik-model" position="0 0 -10" scale="2 2 2" shadow="receive: true"></a-entity>
      <a-entity gltf-model="#signArrow" position="-25 2.6 -20" scale="20 20 20" rotation="0 90 0" shadow="receive: true"></a-entity>
      <a-entity gltf-model="#signArrow" position="-25 2.6 -38" scale="20 20 20" rotation="0 90 0" shadow="receive: true"></a-entity>
      <a-entity gltf-model="#signArrow" position="-25 2.6 -64" scale="20 20 20" rotation="0 90 0" shadow="receive: true"></a-entity>
      <!-- Portal balik ke desa -->
      <a-link change-room="on: obbcollisionstarted; room: desa; url: desa.html" link="on: ignore" href="desa.html"
        position="0 2.6 -5" title="Kembali ke Desa" image="#thumbDesa">
        <a-box position="0 0 0" obb-collider visible="false"></a-box>
      </a-link>

      <!-- Info text -->
      <a-entity id="info-dialog-onload" position="-0.23 4 -39">
        <a-plane width="15" height="1.2" color="#1e293b" opacity="0.92" material="shader: flat"></a-plane>
        <a-text value="Selamat datang di Pabrik! Gunakan portal untuk kembali ke Desa Harmoni." align="center"
          color="#fff" position="0 0 0.05" text="width: 12; wrapCount: 60; font: dejavu; weight: bold"></a-text>
      </a-entity>

      <!-- NPC Pemilik Pabrik -->
      <a-entity id="pemilik pabrik" class="clickable" gltf-model="models/low_poly_little_girl.glb"
        position="0 1.8 -84.98749" npc-dialog-3d="npcId: factory_owner" rotation="0 -3.465248744951219 0">
        <a-cylinder radius="1.2" height="0.45" material="opacity: 0; transparent: true"
          position="3.97959 0.5 -1.44845"></a-cylinder>
        <a-text position="0 2.3848991275597835 0" value="Pemilik Pabrik\nBu Anita " align="center" color="#2F4F4F"
          geometry="primitive: plane; height: 1.4591728525980912; width: 8" material="opacity: 0.9; color: #fff"
          text="value: Pemilik Pabrik\nBu Anita; width: 8; wrapCount: 20"
          animation__bob="dur: 2000; loop: true; property: position; to: 0 2.4 0">
        </a-text>
      </a-entity>
    </a-entity>

    <!-- Rig (player) -->
    <a-entity id="rig" position="0 1.6 0" movement-controls="fly:false; controls: gamepad, trackpad, keyboard, nipple;"
      spawn-in-circle="radius:1" networked="template:#avatar-template; attachTemplateToLocal:false"
      restrict-movement="radius: 10" player-info>
      <a-entity id="player" class="camera" camera position="16 1 -8" rotation="0 120 0" look-controls>
        <a-box obb-collider visible="false" height="0.4" depth="0.4" width="0.4"></a-box>
        <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable; far: 10"></a-entity>
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    AFRAME.registerComponent('hud-coords', {
      tick: function () {
        const player = document.querySelector('#player');
        const hud = document.getElementById('hud');
        if (player && hud) {
          const pos = player.object3D.getWorldPosition(new THREE.Vector3());
          hud.innerText = `Koordinat:\nX: ${pos.x.toFixed(2)}\nY: ${pos.y.toFixed(2)}\nZ: ${pos.z.toFixed(2)}`;
        }
      }
    });

    AFRAME.registerComponent('vr-detector', {
      init: function () {
        this.el.addEventListener('enter-vr', () => gameState.vrMode = true);
        this.el.addEventListener('exit-vr', () => gameState.vrMode = false);
      }
    });

    let gameState = { currentDialog: null, dialogHistory: [], vrMode: false };
  </script>
</body>

</html>