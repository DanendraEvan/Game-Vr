<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>VR Dialog System - Desa Harmoni</title>
  <meta name="description" content="VR Dialog System dengan A-Frame" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>

  <!-- Lib pendukung -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script>
  <script src="/easyrtc/easyrtc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/networked-aframe@0.14.0/dist/networked-aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.5.0/dist/aframe-environment-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fern-solutions/aframe-mirror@1.1.1/dist/mirror.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-cursor-teleport@1.6.0/dist/aframe-cursor-teleport-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AdaRoseCannon/aframe-xr-boilerplate@bca4792/simple-navmesh-constraint.js"></script>
  <script src="/dist/components.js"></script>
  <script defer src="/dist/ui.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { background: #222; }
    ::-webkit-scrollbar { width: 0 !important }
    #hud {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 8px 12px;
      font-family: monospace;
      font-size: 14px;
      border-radius: 5px;
      z-index: 999;
      white-space: pre-line;
    }
    #npc-dialog-overlay {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #npc-dialog-box {
      background: #fff;
      padding: 1.5em;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      font-family: sans-serif;
    }
    #npc-dialog-speaker { font-weight: bold; margin-bottom: .5em; }
    #npc-dialog-choices button {
      display: block;
      margin: .3em 0;
      padding: .6em 1em;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      cursor: pointer;
    }
    #npc-dialog-close {
      background: #dc2626;
      color: #fff;
      border: none;
      padding: .6em 1em;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 1em;
    }
  </style>
</head>
<body>

<div id="hud">Koordinat: X: 0.00 Y: 0.00 Z: 0.00</div>

<a-scene
  networked-scene="connectOnLoad: false; room: desa; debug: true; adapter: wseasyrtc;"
  shadow="type: pcfsoft"
  gltf-model="meshoptDecoderPath:https://unpkg.com/meshoptimizer@0.19.0/meshopt_decoder.js"
  raycaster="far: 10; objects: .clickable"
  cursor="rayOrigin: mouse"
  vr-detector
  hud-coords
>
  <a-assets>
    <template id="avatar-template">
      <a-entity player-info>
        <a-entity class="model">
          <a-text class="nametag" align="center" value="?" position="0 2.1 0" scale=".5 .5 .5"></a-text>
        </a-entity>
        <a-entity class="camera" position="0 1.6 0"></a-entity>
      </a-entity>
    </template>
    <a-asset-item id="village-model" src="village.glb"></a-asset-item>
    <a-asset-item id="koordinator-model" src="../models/wise_man_33.glb"></a-asset-item>
    <a-asset-item id="farmer-model" src="../models/farmer.glb"></a-asset-item>
    <a-asset-item id="pabrik-model" src="../models/low_poly_little_girl.glb"></a-asset-item>
  </a-assets>

  <a-entity id="scene">
    <a-sky color="#87CEEB"></a-sky>
    <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="-1 2 1"></a-entity>
    <a-entity light="type: hemisphere; color: #FFF; groundColor: #808080; intensity: 0.5"></a-entity>
    <a-entity gltf-model="#village-model" position="0 0 -10" scale="1 1 1" shadow="receive: true"></a-entity>

    <!-- NPC Koordinator -->
    <a-entity id="koordinator" gltf-model="#koordinator-model" scale="1 1 1" position="-5 0 -5" class="clickable" data-dialog="koordinator"></a-entity>
    <!-- NPC Petani -->
    <a-entity id="farmer" gltf-model="#farmer-model" scale="1 1 1" position="0 0 -5" class="clickable" data-dialog="farmer"></a-entity>
    <!-- NPC Pemilik Pabrik -->
    <a-entity id="pabrik" gltf-model="#pabrik-model" scale="1 1 1" position="5 0 -5" class="clickable" data-dialog="pabrik"></a-entity>
  </a-entity>

  <a-entity
    id="rig"
    position="0 1.6 0"
    movement-controls="fly:false; controls: gamepad, trackpad, keyboard, nipple;"
    spawn-in-circle="radius:1"
    networked="template:#avatar-template; attachTemplateToLocal:false"
    player-info
  >
    <a-entity id="player" class="camera" camera position="0 1.6 0" look-controls>
      <a-box obb-collider visible="false" height="0.4" depth="0.4" width="0.4"></a-box>
      <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable; far: 10"></a-entity>
    </a-entity>
  </a-entity>
</a-scene>

<!-- Overlay Dialog -->
<div id="npc-dialog-overlay">
  <div id="npc-dialog-box">
    <div id="npc-dialog-speaker"></div>
    <div id="npc-dialog-text"></div>
    <div id="npc-dialog-choices"></div>
    <button id="npc-dialog-close">Tutup</button>
  </div>
</div>

<script>
let gameState = { currentDialog: null };

const dialogData = {
  koordinator: {
    speaker: "Dr. Ahmad Surya - Koordinator Peneliti",
    text: "Selamat datang di Desa Harmoni! Sebagai sosiolog senior, tugasmu adalah mengumpulkan data obyektif tentang konflik kompleks antara sektor pertanian dan industri.",
    choices: [
      { text: "ðŸ”¬ Panduan Metodologi Penelitian", response: "Gunakan etnografi partisipatif, wawancara mendalam, analisis dokumen, dan triangulasi data untuk validitas." },
      { text: "ðŸ‘¥ Identifikasi Key Informants", response: "Informan kunci: Pak Seno (petani senior), Bu Anita (pemilik pabrik), dokumen resmi & kepala desa." },
      { text: "âœ… Validasi Data & Bukti", response: "Cross-check sumber, analisis konsistensi, gunakan bukti empiris (foto, video, pengukuran)." }
    ]
  },
  farmer: {
    speaker: "Pak Seno - Petani Senior",
    text: "Saya sudah bertani di sini 20 tahun. Belakangan ini banyak perubahan yang membuat kami petani khawatir.",
    choices: [
      { text: "ðŸŒ¾ Kondisi Lahan & Hasil Panen", response: "Panen menurun 30%, air keruh, daun padi menguning. Bandingkan dengan sawah jauh dari pabrik hasilnya lebih baik." },
      { text: "ðŸ­ Dampak Keberadaan Pabrik", response: "Air irigasi berubah warna, bau kimia, ikan mati, hasil panen turun, kualitas beras rendah." },
      { text: "ðŸ¤ Solusi & Harapan", response: "Harapan: audit independen, dialog multi-stakeholder, transparansi data air & tanah." }
    ]
  },
  pabrik: {
    speaker: "Bu Anita - Pemilik Pabrik",
    text: "Selamat datang! Kami berkomitmen beroperasi secara bertanggung jawab dan berkelanjutan.",
    choices: [
      { text: "ðŸ”¬ Sistem Pengolahan Limbah", response: "Kami punya IPAL, diuji dua pekan sekali oleh tim independen DLH. Dokumen hasil tersedia untuk publik." },
      { text: "ðŸ¤ Hubungan dengan Komunitas", response: "CSR baru berjalan, ada evaluasi program, transparansi data limbah akan melibatkan warga." },
      { text: "ðŸ“Š Dampak & Kebijakan", response: "Jika terbukti bermasalah, siap investasi perbaikan. Usulkan audit independen bersama dengan warga & pemerintah." }
    ]
  }
};

function showNpcDialog(dialogId) {
  const dialog = dialogData[dialogId];
  if (!dialog) return;
  gameState.currentDialog = dialogId;

  document.getElementById('npc-dialog-speaker').textContent = dialog.speaker;
  document.getElementById('npc-dialog-text').textContent = dialog.text;

  const choicesDiv = document.getElementById('npc-dialog-choices');
  choicesDiv.innerHTML = '';
  dialog.choices.forEach(choice => {
    const btn = document.createElement('button');
    btn.textContent = choice.text;
    btn.onclick = () => {
      document.getElementById('npc-dialog-text').textContent = choice.response;
      choicesDiv.innerHTML = '';
    };
    choicesDiv.appendChild(btn);
  });

  document.getElementById('npc-dialog-overlay').style.display = 'flex';
}
function hideNpcDialog() {
  document.getElementById('npc-dialog-overlay').style.display = 'none';
}
document.getElementById('npc-dialog-close').onclick = hideNpcDialog;

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-dialog]').forEach(el => {
    el.addEventListener('click', () => showNpcDialog(el.getAttribute('data-dialog')));
  });
});
</script>
</body>
</html>
