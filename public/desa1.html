<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>VR Dialog System - Desa Harmoni</title>
  <meta name="description" content="VR Dialog System dengan A-Frame" />

  <!-- A-Frame & Plugins -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script>
  <script src="/easyrtc/easyrtc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/networked-aframe@0.14.0/dist/networked-aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.5.0/dist/aframe-environment-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fern-solutions/aframe-mirror@1.1.1/dist/mirror.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-cursor-teleport@1.6.0/dist/aframe-cursor-teleport-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AdaRoseCannon/aframe-xr-boilerplate@bca4792/simple-navmesh-constraint.js"></script>
  <script src="/dist/components.js"></script>
  <script defer src="/dist/ui.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { background: #222; }
    /* Hide scrollbars on desktop */
    ::-webkit-scrollbar { width: 0 !important }
  </style>
</head>
<body>

<a-scene
  networked-scene="connectOnLoad: false; room: japan; debug: true; adapter: wseasyrtc;"
  shadow="type: pcfsoft"
  gltf-model="meshoptDecoderPath:https://unpkg.com/meshoptimizer@0.19.0/meshopt_decoder.js"
  raycaster="far: 10; objects: .clickable"
  cursor="rayOrigin: mouse"
  vr-detector
>
  <a-assets>
    <template id="avatar-template">
      <a-entity player-info>
        <a-entity class="model">
          <a-text class="nametag" align="center" value="?" position="0 2.1 0" scale=".5 .5 .5"></a-text>
        </a-entity>
        <a-entity class="camera" position="0 1.6 0"></a-entity>
      </a-entity>
    </template>
    <img id="thumbJapan" crossorigin="anonymous" src="https://cdn.aframe.io/link-traversal/thumbs/japan.png" alt="Japan" />
    <img id="thumbForest" crossorigin="anonymous" src="https://cdn.aframe.io/link-traversal/thumbs/forest.png" alt="Forest" />
    <a-asset-item id="village-model" src="villageNaruto.glb"></a-asset-item>
  </a-assets>

  <a-entity id="scene">
    <a-sky color="#87CEEB"></a-sky>
    <a-entity gltf-model="#village-model" position="0 0 -10" scale="0.7 0.7 0.7" material="color: #7BC8A4; metalness: 0; roughness: 1"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="-1 2 1"></a-entity>
    <a-entity light="type: hemisphere; color: #FFF; groundColor: #808080; intensity: 0.5"></a-entity>
    <a-entity gltf-model="#village-model" position="0 0 -10" scale="1 1 1" shadow="receive: true"></a-entity>

    <!-- NPC Koordinator -->
    <a-entity id="koordinator"
      class="clickable"
      gltf-model="url(models/wise_man_33.glb)"
      scale="1 1 1"
      position="-56 2 4"
      npc-dialog-3d="npcId: koordinator"
      rotation="0 70 0">
      <a-cylinder radius="1.2" height="0.45" material="opacity: 0; transparent: true" position="0 0.5 0"></a-cylinder>
      <a-text position="0 2.2 0" value="Koordinator Peneliti\nDr. Ahmad Surya"
        align="center" color="#2F4F4F"
        geometry="primitive: plane; width: auto; height: auto"
        material="color: #fff; opacity: 0.9"
        text="width: 8; wrapCount: 20"
        animation__bob="property: position; to: 0 2.4 0; dur: 2000; loop: true">
      </a-text>
    </a-entity>

    <!-- NPC Pak Seno -->
    <a-entity id="farmer"
      class="clickable"
      gltf-model="url(models/farmer.glb)"
      scale="1 1 1"
      position="-55 1 27"
      rotation="0 30 0"
      npc-dialog-3d="npcId: farmer">
      <a-cylinder radius="1.2" height="0.65" material="opacity: 0; transparent: true" position="0 0.9 0"></a-cylinder>
      <a-text position="0 2.2 0" value="Pak Seno\n(Petani Senior)"
        align="center" color="#2F4F4F"
        geometry="primitive: plane; width: auto; height: auto"
        material="color: #fff; opacity: 0.9"
        text="width: 8; wrapCount: 20"
        animation__bob="property: position; to: 0 2.4 0; dir: alternate; dur: 2000; loop: true">
      </a-text>
    </a-entity>

    <!-- NPC Bu Anita -->
    <a-entity id="pabrik-owner"
      class="clickable"
      gltf-model="url(models/low_poly_little_girl.glb)"
      scale="1 1 1"
      position="-86 2 -5"
      rotation="0 50 0"
      npc-dialog-3d="npcId: pabrik"
      rotation="0 50 0">
      <a-cylinder radius="1.2" height="0.65" material="opacity: 0; transparent: true" position="0 0.9 0"></a-cylinder>
      <a-text position="0 2.2 0" value="Bu Anita\n(Pemilik Pabrik)"
        align="center" color="#2F4F4F"
        geometry="primitive: plane; width: auto; height: auto"
        material="color: #fff; opacity: 0.9"
        text="width: 8; wrapCount: 20"
        animation__bob="property: position; to: 0 2.4 0; dir: alternate; dur: 2000; loop: true">
      </a-text>
    </a-entity>

    <a-link
      change-room="on:obbcollisionstarted;room:forest;url:index.html"
      link="on:ignore"
      href="forest"
      position="-10 1 13"
      image="#thumbForest">
      <a-box position="0 0 0.5" obb-collider visible="false"></a-box>
    </a-link>

    <!-- Info Dialog on Load -->
    <a-entity id="info-dialog-onload" position="0 4 -8">
      <a-plane width="7" height="1.2" color="#1e293b" opacity="0.92" material="shader: flat"></a-plane>
      <a-text 
        value="Selamat datang di Desa Harmoni! Klik pada NPC untuk berbicara dengan mereka."
        align="center"
        color="#fff"
        position="0 0 0.05"
        text="width: 12; wrapCount: 60; font: dejavu; weight: bold"></a-text>
    </a-entity>
  </a-entity>

  <!-- Player rig -->
  <a-entity
    id="rig"
    position="-50 1 5"
    cursor-teleport="cameraRig: #rig; cameraHead: #player; collisionEntities: .environmentGround; ignoreEntities: .clickable,[link]"
    simple-navmesh-constraint="navmesh:.environmentGround,.environmentDressing;fall:10;height:0;exclude:.navmesh-hole;"
    movement-controls="fly:false;controls: gamepad, trackpad, keyboard, nipple;"
    spawn-in-circle="radius:1"
    networked="template:#avatar-template;attachTemplateToLocal:false"
    player-info>
    <a-entity id="player" class="camera" camera position="0 1.6 0" look-controls>
      <a-box obb-collider visible="false" height="0.4" depth="0.4" width="0.4"></a-box>
      <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable; far: 10"></a-entity>
    </a-entity>
  </a-entity>
</a-scene>

<script>
let gameState = {
  currentDialog: null,
  dialogHistory: [],
  vrMode: false
};

// Dialog data dengan struktur hierarkis seperti kode 2 tetapi untuk 3D VR
const NPC_DIALOGS = {
  koordinator: {
    speaker: "Dr. Ahmad Surya - Koordinator Peneliti",
    text: "Selamat datang di Desa Harmoni! Sebagai sosiolog senior, tugasmu adalah mengumpulkan data obyektif tentang konflik kompleks antara sektor pertanian dan industri. Ingat, kebenaran sosiologis terletak pada triangulasi data dari berbagai sumber.",
    tag: "Briefing",
    choices: [
      {
        text: "ðŸ”¬ Panduan Metodologi Penelitian", 
        submenu: "koordinator_metodologi"
      },
      {
        text: "ðŸ‘¥ Identifikasi Key Informants", 
        submenu: "koordinator_informants"
      },
      {
        text: "âœ… Validasi Data & Bukti", 
        submenu: "koordinator_validasi"
      }
    ]
  },
  koordinator_metodologi: {
    speaker: "Dr. Ahmad Surya - Metodologi Penelitian",
    text: "Metodologi penelitian yang tepat adalah kunci keberhasilan riset sosial. Mari kita bahas pendekatan yang sesuai.",
    tag: "Metode",
    choices: [
      {
        text: "Pendekatan Kualitatif - Etnografi Partisipatif", 
        response: "Gunakan pendekatan etnografi partisipatif. Observasi langsung kondisi lapangan, wawancara mendalam dengan stakeholder, dan analisis dokumen sekunder. Ini memungkinkan pemahaman konteks sosial yang mendalam."
      },
      {
        text: "Mixed Methods - Triangulasi Data", 
        response: "Kombinasikan data kualitatif dan kuantitatif. Wawancara mendalam untuk memahami perspektif, survei untuk mengukur sikap, dan observasi untuk memvalidasi temuan. Triangulasi memberikan hasil yang lebih valid."
      },
      {
        text: "Analisis Bias & Subjektivitas", 
        response: "Catat bias potensial dari setiap sumber informasi. Setiap stakeholder punya kepentingan. Sebagai peneliti, Anda harus sadar posisi Anda sendiri dan bagaimana itu memengaruhi interpretasi data."
      }
    ]
  },
  koordinator_informants: {
    speaker: "Dr. Ahmad Surya - Key Informants",
    text: "Identifikasi informan kunci yang tepat akan menentukan kualitas data yang Anda kumpulkan.",
    tag: "Informan",
    choices: [
      {
        text: "Pak Seno - Petani Senior (Pengalaman 20 tahun)", 
        response: "Pak Seno sebagai petani senior dengan pengalaman 20 tahun. Dia punya perspektif historis tentang perubahan kondisi pertanian. Namun ingat, dia juga punya kepentingan ekonomi yang mungkin memengaruhi narasinya."
      },
      {
        text: "Bu Anita - Pemilik Pabrik (Latar Teknik Lingkungan)", 
        response: "Bu Anita pemilik pabrik dengan latar belakang teknik lingkungan. Dia memahami aspek teknis operasional tetapi juga punya kepentingan bisnis. Perspektifnya penting untuk memahami sisi industri."
      },
      {
        text: "Data Objektif - Perpustakaan & Kepala Desa", 
        response: "Data objektif di perpustakaan dan kepala desa sebagai mediator. Dokumen resmi dan pihak netral akan memberikan konteks yang lebih seimbang untuk analisis Anda."
      }
    ]
  },
  koordinator_validasi: {
    speaker: "Dr. Ahmad Surya - Validasi Data",
    text: "Validitas data adalah fondasi kredibilitas penelitian sosiologi.",
    tag: "Validasi",
    choices: [
      {
        text: "Cross-Validation Multiple Sources", 
        response: "Cross-check informasi dari multiple sources. Jangan bergantung pada satu sumber saja. Bandingkan data dari petani, pabrik, dan dokumen resmi untuk menemukan konsistensi atau kontradiksi."
      },
      {
        text: "Analisis Kredibilitas & Konsistensi", 
        response: "Perhatikan konsistensi data dan kredibilitas sumber. Apakah informasi yang diberikan konsisten sepanjang waktu? Apakah sumber memiliki track record yang bisa dipercaya?"
      },
      {
        text: "Dokumentasi Empiris", 
        response: "Dokumentasi foto, video, atau pengukuran langsung akan memperkuat validitas temuan Anda. Bukti empiris yang terukur lebih kuat daripada testimoni subjektif."
      }
    ]
  },
  farmer: {
    speaker: "Pak Seno - Petani Senior",
    text: "Selamat datang di desa kami, Pak. Saya sudah bertani di sini 20 tahun. Belakangan ini ada banyak perubahan yang membuat kami petani khawatir. Kondisi memang tidak seperti dulu lagi.",
    tag: "Testimoni",
    choices: [
      {
        text: "ðŸŒ¾ Kondisi Lahan & Hasil Panen", 
        submenu: "farmer_kondisi"
      },
      {
        text: "ðŸ­ Dampak Keberadaan Pabrik", 
        submenu: "farmer_pabrik"
      },
      {
        text: "ðŸ¤ Solusi & Harapan", 
        submenu: "farmer_solusi"
      }
    ]
  },
  farmer_kondisi: {
    speaker: "Pak Seno - Kondisi Lahan & Panen",
    text: "Tentang kondisi lahan dan hasil panen dua tahun terakhir ini...",
    tag: "Analisis",
    choices: [
      {
        text: "Data Spesifik - Penurunan 30% & Perubahan Visual", 
        response: "Dua tahun terakhir, daun padi banyak yang menguning tidak wajar. Hasil panen menurun drastis sampai 30%, padahal sebelumnya selalu cukup untuk kebutuhan keluarga. Saya catat perubahan itu mulai setelah pabrik berdiri tahun 2022."
      },
      {
        text: "Observasi Komparatif - Banding dengan Area Lain", 
        response: "Yang jelas, air irigasi makin keruh, baunya menyengat. Saya bandingkan dengan sawah Pak Harjo di ujung desa yang jauh dari pabrik, wilayahnya yang airnya masih bersih hasilnya jauh lebih baik. Ada pola yang jelas di sini."
      },
      {
        text: "Perspektif Umum - Nasib Petani", 
        response: "Ya panennya memang nggak begitu bagus, tapi ya sudah namanya nasib petani kadang untung kadang rugi. Musim juga tidak menentu akhir-akhir ini."
      }
    ]
  },
  farmer_pabrik: {
    speaker: "Pak Seno - Dampak Keberadaan Pabrik",
    text: "Tentang perubahan yang terjadi sejak pabrik beroperasi...",
    tag: "Observasi",
    choices: [
      {
        text: "Analisis Kausal - Air & Lingkungan", 
        response: "Setelah ada pabrik, perubahan air irigasi paling kentara. Warna keruh, bau kimia, dan ikan-ikan di saluran banyak yang mati. Ini bukan kebetulan, timing-nya pas setelah pabrik mulai produksi massal."
      },
      {
        text: "Dampak Ekonomi - Penurunan Produktivitas", 
        response: "Selain masalah lingkungan, dampak ekonominya juga terasa. Hasil panen turun, kualitas beras menurun, harga jual ikut turun. Petani-petani muda mulai enggan bertani, lebih milih kerja di kota."
      },
      {
        text: "Perspektif Umum - Perubahan Tak Jelas", 
        response: "Setelah ada pabrik, ya memang banyak yang berubah, tapi saya kurang tahu pasti sebab-akibatnya. Mungkin ada faktor lain juga."
      }
    ]
  },
  farmer_solusi: {
    speaker: "Pak Seno - Solusi & Harapan",
    text: "Tentang harapan dan solusi untuk mengatasi masalah ini...",
    tag: "Solusi",
    choices: [
      {
        text: "Audit Independen - Transparansi Data", 
        response: "Yang paling saya harapkan adalah audit independen yang transparan. Tim netral yang benar-benar tes air dan tanah, hasilnya diumumkan terbuka. Kalau terbukti pabrik salah, harus diperbaiki. Kalau tidak, kita juga harus terima."
      },
      {
        text: "Dialog Multi-Stakeholder", 
        response: "Menurut saya, pemerintah desa, pengelola pabrik, dan petani harus duduk bersama. Evaluasi air dan lahan secara ilmiah, bukan asal tuduh. Semua pihak harus terbuka dan jujur."
      },
      {
        text: "Refleksi Perspektif", 
        response: "Awalnya saya yakin pasti pabrik penyebab semua masalah. Tapi setelah dengar argumen dan dokumen dari mereka, saya mulai sadar perlu bukti yang kuat sebelum menyalahkan siapa-siapa."
      }
    ]
  },
  pabrik: {
    speaker: "Bu Anita - Pemilik Pabrik",
    text: "Selamat datang! Saya Bu Anita, pemilik pabrik pengolahan hasil pertanian. Kami berkomitmen untuk beroperasi secara bertanggung jawab dan berkelanjutan. Kami terbuka untuk diskusi dan transparansi.",
    tag: "Industri",
    choices: [
      {
        text: "ðŸ”¬ Sistem Pengolahan Limbah", 
        submenu: "pabrik_limbah"
      },
      {
        text: "ðŸ¤ Hubungan dengan Komunitas", 
        submenu: "pabrik_komunitas"
      },
      {
        text: "ðŸ“Š Dampak & Kebijakan", 
        submenu: "pabrik_dampak"
      }
    ]
  },
  pabrik_limbah: {
    speaker: "Bu Anita - Sistem Pengolahan Limbah",
    text: "Tentang sistem pengelolaan limbah dan standar operasional kami...",
    tag: "Teknis",
    choices: [
      {
        text: "IPAL & Monitoring Independen", 
        response: "Kami punya sistem IPAL (Instalasi Pengolahan Air Limbah) yang diuji dua pekan sekali oleh tim independen dari Dinas Lingkungan Hidup. Laporan pengujian air selalu dicatat dan dokumen tersedia untuk publik. Kami juga terbuka jika warga ingin inspeksi langsung."
      },
      {
        text: "Sertifikasi & Compliance", 
        response: "Pabrik sudah tersertifikasi ISO 14001 untuk manajemen lingkungan. Kami mengikuti semua regulasi yang ditetapkan pemerintah, bahkan beberapa parameter kami set lebih ketat dari standar minimum yang disyaratkan."
      },
      {
        text: "Perspektif Sederhana", 
        response: "Pabrik sudah punya alat pengolah limbah kok, pasti tidak mungkin langsung buang air kotor ke sungai begitu saja."
      }
    ]
  },
  pabrik_komunitas: {
    speaker: "Bu Anita - Hubungan dengan Komunitas",
    text: "Tentang hubungan kami dengan masyarakat desa dan upaya-upaya yang telah dilakukan...",
    tag: "Sosial",
    choices: [
      {
        text: "Analisis Komunikasi & Dialog", 
        response: "Jujur, kurangnya komunikasi dan minimnya data objektif yang diterima kedua pihak menjadi masalah utama. Kami kadang lalai dalam sosialisasi rutin, sementara warga juga kurang proaktif mencari informasi faktual."
      },
      {
        text: "Program CSR & Evaluasi", 
        response: "Program CSR baru berjalan setahun. Kami evaluasi dari survei kepuasan warga dan realisasi bantuan alat pertanian modern. Beberapa program memang kurang efektif, makanya tahun depan akan ada penyesuaian berdasarkan feedback masyarakat."
      },
      {
        text: "Komitmen Transparansi", 
        response: "Setelah mendengar aspirasi warga kemarin, saya sadar perlu transparansi data limbah secara berkala dan pengawasan rutin yang melibatkan perwakilan warga. Kita akan bentuk tim monitoring bersama."
      }
    ]
  },
  pabrik_dampak: {
    speaker: "Bu Anita - Dampak & Kebijakan",
    text: "Tentang dampak operasional dan kebijakan masa depan...",
    tag: "Strategi",
    choices: [
      {
        text: "Analisis Dampak Pembatasan", 
        response: "Kalau produksi dibatasi drastis, efisiensi operasional turun dan kemungkinan ada pengurangan pekerja lokal. Namun, jika memang terbukti limbah kami bermasalah, kami siap investasi perbaikan proses meski biaya operasional naik."
      },
      {
        text: "Proposal Audit Bersama", 
        response: "Mari kita duduk bersama dengan petani dan pemerintah desa. Kita adakan audit independen dengan biaya ditanggung tiga pihak agar hasilnya benar-benar netral. Pabrik terbuka untuk diskusi dan perbaikan."
      },
      {
        text: "Perspektif Sederhana", 
        response: "Saya harap petani bisa lebih percaya bahwa pabrik tidak bermaksud jahat. Kami juga warga desa ini."
      }
    ]
  }
};

AFRAME.registerComponent('vr-detector', {
  init: function () {
    this.el.addEventListener('enter-vr', () => {
      gameState.vrMode = true;
    });
    this.el.addEventListener('exit-vr', () => {
      gameState.vrMode = false;
    });
  }
});

// 3D Dialog Component dengan update konten instead of recreating panel
AFRAME.registerComponent('npc-dialog-3d', {
  schema: { 
    npcId: { type: 'string' }, 
    distance: { type: 'number', default: 2.5 } 
  },
  init: function () {
    this.dialogStack = []; // Stack untuk tracking menu navigasi
    this.currentPanel = null; // Reference ke panel yang sedang aktif
    this.el.addEventListener('click', (evt) => {
      evt.stopPropagation();
      evt.preventDefault();
      this.dialogStack = []; // reset stack
      this.showDialog(this.data.npcId);
    });
  },
  
  showDialog: function (dialogId) {
    const scene = this.el.sceneEl;
    const dialog = NPC_DIALOGS[dialogId];
    if (!dialog) {
      console.error('Dialog not found:', dialogId);
      return;
    }

    // Jika panel belum ada, buat panel baru
    if (!this.currentPanel || !this.currentPanel.parentNode) {
      this.createDialogPanel();
    }

    // Update konten panel yang sudah ada
    this.updateDialogContent(dialog, dialogId);
  },

  createDialogPanel: function() {
    const scene = this.el.sceneEl;
    
    // Hapus panel lama jika ada
    const existing = scene.querySelector('#dialog-panel');
    if (existing) existing.parentNode.removeChild(existing);

    const panel = document.createElement('a-entity');
    panel.setAttribute('id', 'dialog-panel');
    panel.setAttribute('geometry', { primitive: 'plane', width: 4, height: 3 });
    panel.setAttribute('material', { color: '#1a1a1a', opacity: 0.95 });

    // Posisi panel di depan kamera menggunakan world coordinates
    const camera = scene.querySelector('[camera]');
    const camPos = new THREE.Vector3();
    camera.object3D.getWorldPosition(camPos);
    const camDir = new THREE.Vector3();
    camera.object3D.getWorldDirection(camDir);

    const panelPos = camPos.clone().add(camDir.multiplyScalar(this.data.distance));
    panelPos.y -= 0.3;
    panel.setAttribute('position', `${panelPos.x} ${panelPos.y} ${panelPos.z}`);

    const lookAtPos = camPos.clone();
    lookAtPos.y = panelPos.y;
    panel.object3D.lookAt(lookAtPos);

    // Border panel
    const border = document.createElement('a-plane');
    border.setAttribute('id', 'dialog-border');
    border.setAttribute('geometry', { primitive: 'plane', width: 4.1, height: 3.1 });
    border.setAttribute('material', { color: '#4CAF50', opacity: 0.8 });
    border.setAttribute('position', '0 0 -0.01');
    panel.appendChild(border);

    // Header dengan nama NPC dan tag
    const header = document.createElement('a-plane');
    header.setAttribute('id', 'dialog-header');
    header.setAttribute('geometry', { primitive: 'plane', width: 3.8, height: 0.4 });
    header.setAttribute('material', { color: '#2196F3' });
    header.setAttribute('position', '0 1.25 0.02');
    
    const title = document.createElement('a-text');
    title.setAttribute('id', 'dialog-title');
    title.setAttribute('align', 'center');
    title.setAttribute('width', 3);
    title.setAttribute('position', '0 0 0.02');
    title.setAttribute('color', 'white');
    title.setAttribute('font', 'dejavu');
    header.appendChild(title);

    // Tag dialog
    const tag = document.createElement('a-plane');
    tag.setAttribute('id', 'dialog-tag');
    tag.setAttribute('geometry', { primitive: 'plane', width: 1, height: 0.2 });
    tag.setAttribute('material', { color: '#FFD700', opacity: 0.9 });
    tag.setAttribute('position', '1.4 1.25 0.03');
    
    const tagText = document.createElement('a-text');
    tagText.setAttribute('id', 'dialog-tag-text');
    tagText.setAttribute('align', 'center');
    tagText.setAttribute('width', 2.5);
    tagText.setAttribute('position', '0 0 0.02');
    tagText.setAttribute('color', '#1a1a1a');
    tagText.setAttribute('font', 'dejavu');
    tag.appendChild(tagText);
    panel.appendChild(tag);
    
    panel.appendChild(header);

    // Dialog text area
    const dialogArea = document.createElement('a-plane');
    dialogArea.setAttribute('id', 'dialog-text-area');
    dialogArea.setAttribute('geometry', { primitive: 'plane', width: 3.8, height: 1 });
    dialogArea.setAttribute('material', { color: '#f8fafc', opacity: 0.95 });
    dialogArea.setAttribute('position', '0 0.5 0.02');
    
    const dialogText = document.createElement('a-text');
    dialogText.setAttribute('id', 'dialog-main-text');
    dialogText.setAttribute('align', 'center');
    dialogText.setAttribute('color', '#1a1a1a');
    dialogText.setAttribute('width', 3.2);
    dialogText.setAttribute('position', '0 0 0.02');
    dialogText.setAttribute('wrap-count', 60);
    dialogText.setAttribute('line-height', 40);
    dialogArea.appendChild(dialogText);
    panel.appendChild(dialogArea);

    // Choices container
    const choicesContainer = document.createElement('a-entity');
    choicesContainer.setAttribute('id', 'dialog-choices-container');
    choicesContainer.setAttribute('position', '0 -0.3 0.02');
    panel.appendChild(choicesContainer);

    // Navigation buttons container
    const navContainer = document.createElement('a-entity');
    navContainer.setAttribute('id', 'dialog-nav-container');
    navContainer.setAttribute('position', '0 -1.2 0.02');
    panel.appendChild(navContainer);

    scene.appendChild(panel);
    this.currentPanel = panel;
  },

  updateDialogContent: function(dialog, dialogId) {
    // Update title
    const title = this.currentPanel.querySelector('#dialog-title');
    title.setAttribute('value', dialog.speaker);

    // Update tag
    const tagText = this.currentPanel.querySelector('#dialog-tag-text');
    if (dialog.tag) {
      tagText.setAttribute('value', dialog.tag);
      this.currentPanel.querySelector('#dialog-tag').setAttribute('visible', true);
    } else {
      this.currentPanel.querySelector('#dialog-tag').setAttribute('visible', false);
    }

    // Update main text
    const mainText = this.currentPanel.querySelector('#dialog-main-text');
    mainText.setAttribute('value', dialog.text);

    // Clear and update choices
    const choicesContainer = this.currentPanel.querySelector('#dialog-choices-container');
    this.clearContainer(choicesContainer);

    if (dialog.choices && dialog.choices.length > 0) {
      dialog.choices.forEach((choice, index) => {
        const choiceBtn = document.createElement('a-plane');
        const btnHeight = 0.3;
        const spacing = 0.35;
        const startY = ((dialog.choices.length - 1) * spacing) / 2;
        
        choiceBtn.setAttribute('geometry', { primitive: 'plane', width: 3.6, height: btnHeight });
        
        // Tentukan warna berdasarkan jenis pilihan
        let btnColor = '#3b82f6'; // default blue untuk submenu
        if (choice.response) {
          btnColor = '#10b981'; // green untuk pilihan yang ada responsenya
        }
        
        choiceBtn.setAttribute('material', { color: btnColor });
        choiceBtn.setAttribute('position', `0 ${startY - (index * spacing)} 0`);
        choiceBtn.classList.add('clickable');
        choiceBtn.setAttribute('animation__hover', 'property: scale; to: 1.05 1.05 1.05; startEvents: mouseenter; dur: 200');
        choiceBtn.setAttribute('animation__leave', 'property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200');

        const choiceLabel = document.createElement('a-text');
        choiceLabel.setAttribute('value', choice.text);
        choiceLabel.setAttribute('align', 'center');
        choiceLabel.setAttribute('color', 'white');
        choiceLabel.setAttribute('width', 2.8);
        choiceLabel.setAttribute('wrap-count', 50);
        choiceLabel.setAttribute('position', '0 0 0.02');
        choiceBtn.appendChild(choiceLabel);

        const self = this;
        choiceBtn.addEventListener('click', function (evt) {
          evt.stopPropagation();
          evt.preventDefault();
          
          if (choice.submenu) {
            // Navigate to submenu - update stack and content
            self.dialogStack.push(dialogId);
            self.showDialog(choice.submenu);
          } else if (choice.response) {
            // Show response - update content to response mode
            self.showResponse(choice.response);
          }
        });

        choicesContainer.appendChild(choiceBtn);
      });
    }

    // Update navigation buttons
    this.updateNavigationButtons(dialogId);
  },

  updateNavigationButtons: function(dialogId) {
    const navContainer = this.currentPanel.querySelector('#dialog-nav-container');
    this.clearContainer(navContainer);

    // Back button for submenus
    if (this.dialogStack.length > 0) {
      const backBtn = document.createElement('a-plane');
      backBtn.setAttribute('geometry', { primitive: 'plane', width: 1.5, height: 0.25 });
      backBtn.setAttribute('material', { color: '#6b7280' });
      backBtn.setAttribute('position', '-1 0 0');
      backBtn.classList.add('clickable');
      
      const backLabel = document.createElement('a-text');
      backLabel.setAttribute('value', 'â† Kembali');
      backLabel.setAttribute('align', 'center');
      backLabel.setAttribute('color', 'white');
      backLabel.setAttribute('width', 2.5);
      backLabel.setAttribute('position', '0 0 0.02');
      backBtn.appendChild(backLabel);

      const self = this;
      backBtn.addEventListener('click', function (evt) {
        evt.stopPropagation();
        evt.preventDefault();
        const previousDialog = self.dialogStack.pop();
        if (previousDialog) {
          self.showDialog(previousDialog);
        }
      });

      navContainer.appendChild(backBtn);
    }

    // Close button
    const closeBtn = document.createElement('a-plane');
    closeBtn.setAttribute('geometry', { primitive: 'plane', width: 1, height: 0.25 });
    closeBtn.setAttribute('material', { color: '#f44336' });
    closeBtn.setAttribute('position', '1 0 0');
    closeBtn.classList.add('clickable');
    
    const closeLabel = document.createElement('a-text');
    closeLabel.setAttribute('value', 'âœ• Tutup');
    closeLabel.setAttribute('align', 'center');
    closeLabel.setAttribute('color', 'white');
    closeLabel.setAttribute('width', 2);
    closeLabel.setAttribute('position', '0 0 0.02');
    closeBtn.appendChild(closeLabel);
    
    const self = this;
    closeBtn.addEventListener('click', function (evt) {
      evt.stopPropagation();
      evt.preventDefault();
      if (self.currentPanel && self.currentPanel.parentNode) {
        self.currentPanel.parentNode.removeChild(self.currentPanel);
        self.currentPanel = null;
      }
    });

    navContainer.appendChild(closeBtn);
  },

  showResponse: function(responseText) {
    // Update panel to response mode instead of creating new panel
    const mainText = this.currentPanel.querySelector('#dialog-main-text');
    mainText.setAttribute('value', responseText);

    // Hide choices and show back to dialog button
    const choicesContainer = this.currentPanel.querySelector('#dialog-choices-container');
    this.clearContainer(choicesContainer);

    // Update navigation for response mode
    const navContainer = this.currentPanel.querySelector('#dialog-nav-container');
    this.clearContainer(navContainer);

    // Back to dialog button
    const backBtn = document.createElement('a-plane');
    backBtn.setAttribute('geometry', { primitive: 'plane', width: 2, height: 0.3 });
    backBtn.setAttribute('material', { color: '#1976D2' });
    backBtn.setAttribute('position', '0 0 0');
    backBtn.classList.add('clickable');
    
    const backLabel = document.createElement('a-text');
    backLabel.setAttribute('value', 'â† Kembali ke Dialog');
    backLabel.setAttribute('align', 'center');
    backLabel.setAttribute('color', 'white');
    backLabel.setAttribute('width', 2.5);
    backLabel.setAttribute('position', '0 0 0.02');
    backBtn.appendChild(backLabel);

    const self = this;
    backBtn.addEventListener('click', function (evt) {
      evt.stopPropagation();
      evt.preventDefault();
      // Go back to previous dialog or main menu
      const previousDialog = self.dialogStack.length > 0 ? self.dialogStack[self.dialogStack.length - 1] : self.data.npcId;
      self.showDialog(previousDialog);
    });

    navContainer.appendChild(backBtn);

    // Auto return to dialog after 8 seconds
    setTimeout(() => {
      if (self.currentPanel && self.currentPanel.parentNode) {
        const previousDialog = self.dialogStack.length > 0 ? self.dialogStack[self.dialogStack.length - 1] : self.data.npcId;
        self.showDialog(previousDialog);
      }
    }, 8000);
  },

  clearContainer: function(container) {
    while (container.firstChild) {
      container.removeChild(container.firstChild);
    }
  }
});

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Hide info dialog after 5 seconds
  setTimeout(() => {
    const infoDialog = document.getElementById('info-dialog-onload');
    if (infoDialog) {
      infoDialog.setAttribute('visible', false);
    }
  }, 5000);
});
</script>
</body>
</html>