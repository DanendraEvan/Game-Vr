<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>VR Dialog System - Desa Harmoni</title>
  <meta name="description" content="VR Dialog System dengan A-Frame" />

  <!-- A-Frame & Plugins -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script>
  <script src="/easyrtc/easyrtc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/networked-aframe@0.14.0/dist/networked-aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.5.0/dist/aframe-environment-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fern-solutions/aframe-mirror@1.1.1/dist/mirror.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-cursor-teleport@1.6.0/dist/aframe-cursor-teleport-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AdaRoseCannon/aframe-xr-boilerplate@bca4792/simple-navmesh-constraint.js"></script>
  <script src="/dist/components.js"></script>
  <script defer src="/dist/ui.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { background: #222; }
    /* Hide scrollbars on desktop */
    ::-webkit-scrollbar { width: 0 !important }
    
    #hud-score {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      font-family: Arial, sans-serif;
      font-size: 16px;
      border-radius: 5px;
      z-index: 999;
      border: 2px solid #4CAF50;
    }
  </style>
</head>
<body>
<div id="hud-score">Skor: 0</div>

<a-scene
  networked-scene="connectOnLoad: false; room: japan; debug: true; adapter: wseasyrtc;"
  shadow="type: pcfsoft"
  gltf-model="meshoptDecoderPath:https://unpkg.com/meshoptimizer@0.19.0/meshopt_decoder.js"
  raycaster="far: 10; objects: .clickable"
  cursor="rayOrigin: mouse"
  vr-detector
>
  <a-assets>
    <template id="avatar-template">
      <a-entity player-info>
        <a-entity class="model">
          <a-text class="nametag" align="center" value="?" position="0 2.1 0" scale=".5 .5 .5"></a-text>
        </a-entity>
        <a-entity class="camera" position="0 1.6 0"></a-entity>
      </a-entity>
    </template>
    <img id="thumbJapan" crossorigin="anonymous" src="https://cdn.aframe.io/link-traversal/thumbs/japan.png" alt="Japan" />
    <img id="thumbForest" crossorigin="anonymous" src="https://cdn.aframe.io/link-traversal/thumbs/forest.png" alt="Forest" />
    <a-asset-item id="village-model" src="villageNaruto.glb"></a-asset-item>
  </a-assets>

  <a-entity id="scene">
    <a-sky color="#87CEEB"></a-sky>
    <a-entity gltf-model="#village-model" position="0 0 -10" scale="0.7 0.7 0.7" material="color: #7BC8A4; metalness: 0; roughness: 1"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="-1 2 1"></a-entity>
    <a-entity light="type: hemisphere; color: #FFF; groundColor: #808080; intensity: 0.5"></a-entity>
    <a-entity gltf-model="#village-model" position="0 0 -10" scale="1 1 1" shadow="receive: true"></a-entity>

    <!-- NPC Koordinator -->
    <a-entity id="koordinator"
      class="clickable"
      gltf-model="url(models/wise_man_33.glb)"
      scale="1 1 1"
      position="-56 2 4"
      npc-dialog-3d="npcId: koordinator"
      rotation="0 70 0">
      <a-cylinder radius="1.2" height="0.45" material="opacity: 0; transparent: true" position="0 0.5 0"></a-cylinder>
      <a-text position="0 2.2 0" value="Koordinator Peneliti\nDr. Ahmad Surya"
        align="center" color="#2F4F4F"
        geometry="primitive: plane; width: auto; height: auto"
        material="color: #fff; opacity: 0.9"
        text="width: 8; wrapCount: 20"
        animation__bob="property: position; to: 0 2.4 0; dur: 2000; loop: true">
      </a-text>
    </a-entity>

    <!-- NPC Pak Seno -->
    <a-entity id="farmer"
      class="clickable"
      gltf-model="url(models/farmer.glb)"
      scale="1 1 1"
      position="-55 1 27"
      rotation="0 30 0"
      npc-dialog-3d="npcId: farmer">
      <a-cylinder radius="1.2" height="0.65" material="opacity: 0; transparent: true" position="0 0.9 0"></a-cylinder>
      <a-text position="0 2.2 0" value="Pak Seno\n(Petani Senior)"
        align="center" color="#2F4F4F"
        geometry="primitive: plane; width: auto; height: auto"
        material="color: #fff; opacity: 0.9"
        text="width: 8; wrapCount: 20"
        animation__bob="property: position; to: 0 2.4 0; dir: alternate; dur: 2000; loop: true">
      </a-text>
    </a-entity>

    <!-- NPC Bu Anita -->
    <a-entity id="pabrik-owner"
      class="clickable"
      gltf-model="url(models/low_poly_little_girl.glb)"
      scale="1 1 1"
      position="-86 2 -5"
      rotation="0 50 0"
      npc-dialog-3d="npcId: pabrik"
      rotation="0 50 0">
      <a-cylinder radius="1.2" height="0.65" material="opacity: 0; transparent: true" position="0 0.9 0"></a-cylinder>
      <a-text position="0 2.2 0" value="Bu Anita\n(Pemilik Pabrik)"
        align="center" color="#2F4F4F"
        geometry="primitive: plane; width: auto; height: auto"
        material="color: #fff; opacity: 0.9"
        text="width: 8; wrapCount: 20"
        animation__bob="property: position; to: 0 2.4 0; dir: alternate; dur: 2000; loop: true">
      </a-text>
    </a-entity>

    <a-link
      change-room="on:obbcollisionstarted;room:forest;url:index.html"
      link="on:ignore"
      href="forest"
      position="-10 1 13"
      image="#thumbForest">
      <a-box position="0 0 0.5" obb-collider visible="false"></a-box>
    </a-link>

    <!-- Info Dialog on Load -->
    <a-entity id="info-dialog-onload" position="0 4 -8">
      <a-plane width="7" height="1.2" color="#1e293b" opacity="0.92" material="shader: flat"></a-plane>
      <a-text 
        value="Selamat datang di Desa Harmoni! Klik pada NPC untuk berbicara dengan mereka."
        align="center"
        color="#fff"
        position="0 0 0.05"
        text="width: 12; wrapCount: 60; font: dejavu; weight: bold"></a-text>
    </a-entity>
  </a-entity>

  <!-- Player rig -->
  <a-entity
    id="rig"
    position="-50 1 5"
    cursor-teleport="cameraRig: #rig; cameraHead: #player; collisionEntities: .environmentGround; ignoreEntities: .clickable,[link]"
    simple-navmesh-constraint="navmesh:.environmentGround,.environmentDressing;fall:10;height:0;exclude:.navmesh-hole;"
    movement-controls="fly:false;controls: gamepad, trackpad, keyboard, nipple;"
    spawn-in-circle="radius:1"
    networked="template:#avatar-template;attachTemplateToLocal:false"
    player-info>
    <a-entity id="player" class="camera" camera position="0 1.6 0" look-controls>
      <a-box obb-collider visible="false" height="0.4" depth="0.4" width="0.4"></a-box>
      <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable; far: 10"></a-entity>
    </a-entity>
  </a-entity>
</a-scene>

<script>
let gameState = {
  currentDialog: null,
  dialogHistory: [],
  vrMode: false
};

// Dialog data untuk setiap NPC
const NPC_DIALOGS = {
  koordinator: [
    {
      question: "Selamat datang! Saya Dr. Ahmad Surya, koordinator penelitian di desa ini. Apa yang ingin Anda ketahui tentang kondisi desa?",
      options: {
        kritis: "Saya ingin tahu tentang masalah lingkungan di desa ini.",
        alternatif: "Ceritakan tentang kehidupan sehari-hari di desa."
      }
    },
    {
      question: "Desa Harmoni menghadapi beberapa tantangan. Penelitian kami menunjukkan adanya perubahan signifikan. Apa fokus investigasi Anda?",
      options: {
        kritis: "Bagaimana dampak industri terhadap lingkungan?",
        alternatif: "Apa saja program pemberdayaan masyarakat?"
      }
    },
    {
      question: "Data menunjukkan korelasi antara aktivitas industri dan penurunan kualitas lingkungan. Langkah apa yang Anda rekomendasikan?",
      options: {
        kritis: "Perlu monitoring ketat terhadap limbah industri.",
        alternatif: "Fokus pada edukasi masyarakat saja sudah cukup."
      }
    }
  ],
  farmer: [
    {
      question: "Selamat pagi! Saya Pak Seno, sudah 30 tahun bertani di sini. Bagaimana Bapak menggambarkan kondisi lahan dan hasil panen?",
      options: {
        kritis: "Daun padi menguning, hasil panen menurun 30%.",
        alternatif: "Panennya tidak bagus, namanya juga nasib."
      }
    },
    {
      question: "Apa penyebab utama penurunan hasil panen menurut Bapak?",
      options: {
        kritis: "Perubahan iklim dan kurangnya air irigasi yang bersih.",
        alternatif: "Sumber daya manusia sudah tua dan malas."
      }
    },
    {
      question: "Bagaimana pandangan Bapak tentang anak muda yang enggan bertani?",
      options: {
        kritis: "Mereka kurang tertarik karena melihat pertanian kurang menjanjikan.",
        alternatif: "Anak muda lebih suka kerja di kota dan sektor lain."
      }
    }
  ],
  pabrik: [
    {
      question: "Halo! Saya Bu Anita, pemilik pabrik tekstil di desa ini. Bagaimana pendapat Anda tentang kontribusi industri untuk desa?",
      options: {
        kritis: "Industri perlu lebih memperhatikan dampak lingkungan.",
        alternatif: "Industri membawa kemajuan ekonomi untuk desa."
      }
    },
    {
      question: "Pabrik kami sudah beroperasi 10 tahun. Menurut Anda, apa yang perlu diperbaiki dari operasional kami?",
      options: {
        kritis: "Sistem pengolahan limbah perlu ditingkatkan.",
        alternatif: "Perlu lebih banyak program CSR untuk masyarakat."
      }
    },
    {
      question: "Kami berkomitmen pada pembangunan berkelanjutan. Apa prioritas utama yang harus kami fokuskan?",
      options: {
        kritis: "Transparansi dalam pengelolaan limbah dan dampak lingkungan.",
        alternatif: "Meningkatkan kesejahteraan karyawan dan masyarakat sekitar."
      }
    }
  ]
};

AFRAME.registerComponent('vr-detector', {
  init: function () {
    this.el.addEventListener('enter-vr', () => {
      gameState.vrMode = true;
    });
    this.el.addEventListener('exit-vr', () => {
      gameState.vrMode = false;
    });
  }
});

// Update score display
function updateScoreDisplay() {
  const score = localStorage.getItem('score') || 0;
  document.getElementById('hud-score').innerText = `Skor: ${score}`;
}

// 3D Dialog Component
AFRAME.registerComponent('npc-dialog-3d', {
  schema: { 
    npcId: { type: 'string' }, 
    distance: { type: 'number', default: 2.5 } 
  },
  init: function () {
    this.dialogIndex = 0;
    this.el.addEventListener('click', (evt) => {
      evt.stopPropagation();
      evt.preventDefault();
      this.dialogIndex = 0; // reset dialog tiap klik awal
      this.showDialog();
    });
  },
  
  showDialog: function () {
    const scene = this.el.sceneEl;
    const existing = scene.querySelector('#dialog-panel');
    if (existing) existing.parentNode.removeChild(existing);

    const npcDialogs = NPC_DIALOGS[this.data.npcId];
    if (!npcDialogs || this.dialogIndex >= npcDialogs.length) {
      // Selesai dialog
      this.showCompletionMessage();
      this.dialogIndex = 0;
      return;
    }

    const data = npcDialogs[this.dialogIndex];

    const panel = document.createElement('a-entity');
    panel.setAttribute('id', 'dialog-panel');
    panel.setAttribute('geometry', { primitive: 'plane', width: 3, height: 2.2 });
    panel.setAttribute('material', { color: '#1a1a1a', opacity: 0.95 });

    // Ambil kamera
    const camera = scene.querySelector('[camera]');
    const camPos = new THREE.Vector3();
    camera.object3D.getWorldPosition(camPos);
    const camDir = new THREE.Vector3();
    camera.object3D.getWorldDirection(camDir);

    // Posisi panel langsung di depan kamera
    const panelPos = camPos.clone().add(camDir.multiplyScalar(this.data.distance));
    panelPos.y -= 0.3; // turunkan sedikit agar nyaman dilihat
    panel.setAttribute('position', `${panelPos.x} ${panelPos.y} ${panelPos.z}`);

    // Agar panel menghadap kamera
    const lookAtPos = camPos.clone();
    lookAtPos.y = panelPos.y;
    panel.object3D.lookAt(lookAtPos);

    // Border panel
    const border = document.createElement('a-plane');
    border.setAttribute('geometry', { primitive: 'plane', width: 3.1, height: 2.3 });
    border.setAttribute('material', { color: '#4CAF50', opacity: 0.8 });
    border.setAttribute('position', '0 0 -0.01');
    panel.appendChild(border);

    // Header dengan nama NPC
    const header = document.createElement('a-plane');
    header.setAttribute('geometry', { primitive: 'plane', width: 2.8, height: 0.3 });
    header.setAttribute('material', { color: '#2196F3' });
    header.setAttribute('position', '0 0.85 0.02');
    
    const npcNames = {
      koordinator: "Dr. Ahmad Surya (Koordinator Peneliti)",
      farmer: "Pak Seno (Petani Senior)",
      pabrik: "Bu Anita (Pemilik Pabrik)"
    };
    
    const title = document.createElement('a-text');
    title.setAttribute('value', npcNames[this.data.npcId] || "NPC");
    title.setAttribute('align', 'center');
    title.setAttribute('width', 2.5);
    title.setAttribute('position', '0 0 0.02');
    title.setAttribute('color', 'white');
    title.setAttribute('font', 'dejavu');
    header.appendChild(title);
    panel.appendChild(header);

    // Pertanyaan/dialog
    const dialogArea = document.createElement('a-plane');
    dialogArea.setAttribute('geometry', { primitive: 'plane', width: 2.8, height: 0.8 });
    dialogArea.setAttribute('material', { color: '#f8fafc', opacity: 0.95 });
    dialogArea.setAttribute('position', '0 0.2 0.02');
    
    const prompt = document.createElement('a-text');
    prompt.setAttribute('value', data.question);
    prompt.setAttribute('align', 'center');
    prompt.setAttribute('color', '#1a1a1a');
    prompt.setAttribute('width', 2.3);
    prompt.setAttribute('position', '0 0 0.02');
    prompt.setAttribute('wrap-count', 50);
    prompt.setAttribute('line-height', 45);
    dialogArea.appendChild(prompt);
    panel.appendChild(dialogArea);

    // Tombol pilihan
    const btnWidth = 1.2;
    const btnHeight = 0.35;

    // Tombol Kritis (Hijau)
    const kritisBtn = document.createElement('a-plane');
    kritisBtn.setAttribute('geometry', { primitive: 'plane', width: btnWidth, height: btnHeight });
    kritisBtn.setAttribute('material', { color: '#4CAF50' });
    kritisBtn.setAttribute('position', '-0.7 -0.6 0.02');
    kritisBtn.classList.add('clickable');
    kritisBtn.setAttribute('animation__hover', 'property: scale; to: 1.05 1.05 1.05; startEvents: mouseenter; dur: 200');
    kritisBtn.setAttribute('animation__leave', 'property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200');

    // Tombol Alternatif (Biru)
    const altBtn = document.createElement('a-plane');
    altBtn.setAttribute('geometry', { primitive: 'plane', width: btnWidth, height: btnHeight });
    altBtn.setAttribute('material', { color: '#2196F3' });
    altBtn.setAttribute('position', '0.7 -0.6 0.02');
    altBtn.classList.add('clickable');
    altBtn.setAttribute('animation__hover', 'property: scale; to: 1.05 1.05 1.05; startEvents: mouseenter; dur: 200');
    altBtn.setAttribute('animation__leave', 'property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200');

    // Label tombol
    const kritisLabel = document.createElement('a-text');
    kritisLabel.setAttribute('value', data.options.kritis);
    kritisLabel.setAttribute('align', 'center');
    kritisLabel.setAttribute('color', 'white');
    kritisLabel.setAttribute('width', 1.8);
    kritisLabel.setAttribute('wrap-count', 25);
    kritisLabel.setAttribute('position', '0 0 0.02');
    kritisBtn.appendChild(kritisLabel);

    const altLabel = document.createElement('a-text');
    altLabel.setAttribute('value', data.options.alternatif);
    altLabel.setAttribute('align', 'center');
    altLabel.setAttribute('color', 'white');
    altLabel.setAttribute('width', 1.8);
    altLabel.setAttribute('wrap-count', 25);
    altLabel.setAttribute('position', '0 0 0.02');
    altBtn.appendChild(altLabel);

    // Tombol Close
    const closeBtn = document.createElement('a-plane');
    closeBtn.setAttribute('geometry', { primitive: 'plane', width: 0.8, height: 0.25 });
    closeBtn.setAttribute('material', { color: '#f44336' });
    closeBtn.setAttribute('position', '0 -1 0.02');
    closeBtn.classList.add('clickable');
    
    const closeLabel = document.createElement('a-text');
    closeLabel.setAttribute('value', '✕ Tutup');
    closeLabel.setAttribute('align', 'center');
    closeLabel.setAttribute('color', 'white');
    closeLabel.setAttribute('width', 2);
    closeLabel.setAttribute('position', '0 0 0.02');
    closeBtn.appendChild(closeLabel);

    const self = this;
    
    kritisBtn.addEventListener('click', function (evt) {
      evt.stopPropagation();
      evt.preventDefault();
      self.handleAnswer('kritis');
    });
    
    altBtn.addEventListener('click', function (evt) {
      evt.stopPropagation();
      evt.preventDefault();
      self.handleAnswer('alternatif');
    });
    
    closeBtn.addEventListener('click', function (evt) {
      evt.stopPropagation();
      evt.preventDefault();
      const panel = scene.querySelector('#dialog-panel');
      if (panel) panel.parentNode.removeChild(panel);
    });

    panel.appendChild(kritisBtn);
    panel.appendChild(altBtn);
    panel.appendChild(closeBtn);

    scene.appendChild(panel);
  },
  
  handleAnswer: function (type) {
    let score = parseInt(localStorage.getItem('score') || '0', 10);
    score += (type === 'kritis' ? 10 : 2);
    localStorage.setItem('score', score);
    updateScoreDisplay();

    // Hapus panel saat ini
    const panel = this.el.sceneEl.querySelector('#dialog-panel');
    if (panel) panel.parentNode.removeChild(panel);

    // Increment dan show dialog berikutnya
    this.dialogIndex++;
    
    // Delay sebentar sebelum menampilkan dialog berikutnya
    setTimeout(() => {
      this.showDialog();
    }, 500);
  },
  
  showCompletionMessage: function() {
    const scene = this.el.sceneEl;
    
    const panel = document.createElement('a-entity');
    panel.setAttribute('id', 'dialog-panel');
    panel.setAttribute('geometry', { primitive: 'plane', width: 2.5, height: 1.5 });
    panel.setAttribute('material', { color: '#4CAF50', opacity: 0.9 });

    const camera = scene.querySelector('[camera]');
    const camPos = new THREE.Vector3();
    camera.object3D.getWorldPosition(camPos);
    const camDir = new THREE.Vector3();
    camera.object3D.getWorldDirection(camDir);

    const panelPos = camPos.clone().add(camDir.multiplyScalar(this.data.distance));
    panelPos.y -= 0.3;
    panel.setAttribute('position', `${panelPos.x} ${panelPos.y} ${panelPos.z}`);

    const lookAtPos = camPos.clone();
    lookAtPos.y = panelPos.y;
    panel.object3D.lookAt(lookAtPos);

    const message = document.createElement('a-text');
    message.setAttribute('value', 'Terima kasih atas waktunya!\nInvestigasi dengan NPC ini selesai.');
    message.setAttribute('align', 'center');
    message.setAttribute('color', 'white');
    message.setAttribute('width', 2);
    message.setAttribute('position', '0 0.2 0.02');
    
    const closeBtn = document.createElement('a-plane');
    closeBtn.setAttribute('geometry', { primitive: 'plane', width: 1, height: 0.3 });
    closeBtn.setAttribute('material', { color: '#1976D2' });
    closeBtn.setAttribute('position', '0 -0.4 0.02');
    closeBtn.classList.add('clickable');
    
    const closeLabel = document.createElement('a-text');
    closeLabel.setAttribute('value', 'OK');
    closeLabel.setAttribute('align', 'center');
    closeLabel.setAttribute('color', 'white');
    closeLabel.setAttribute('width', 2);
    closeLabel.setAttribute('position', '0 0 0.02');
    closeBtn.appendChild(closeLabel);
    
    closeBtn.addEventListener('click', function (evt) {
      evt.stopPropagation();
      evt.preventDefault();
      const panel = scene.querySelector('#dialog-panel');
      if (panel) panel.parentNode.removeChild(panel);
    });

    panel.appendChild(message);
    panel.appendChild(closeBtn);
    scene.appendChild(panel);
    
    // Auto close after 3 seconds
    setTimeout(() => {
      const existingPanel = scene.querySelector('#dialog-panel');
      if (existingPanel) existingPanel.parentNode.removeChild(existingPanel);
    }, 3000);
  }
});

// Initialize score display when page loads
document.addEventListener('DOMContentLoaded', function() {
  updateScoreDisplay();
  
  // Hide info dialog after 5 seconds
  setTimeout(() => {
    const infoDialog = document.getElementById('info-dialog-onload');
    if (infoDialog) {
      infoDialog.setAttribute('visible', false);
    }
  }, 5000);
});
</script>
</body>
</html>